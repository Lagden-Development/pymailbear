{% extends "layout.html" %}

{% block title %}API Documentation - {{ form.name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ form.name }} API Documentation</h1>
    <div class="actions">
        <a href="/forms/edit/{{ form.id }}" class="btn btn-primary">Edit Form</a>
        <a href="/forms" class="btn btn-secondary">Back to Forms</a>
    </div>
</div>

<div class="card">
    <h2>API Endpoint</h2>
    <p>Submit forms to this endpoint for processing and email delivery:</p>
    
    <div class="endpoint-details">
        <div class="endpoint-url">
            <strong>POST</strong> <code>{{ request.base_url }}api/v1/form/{{ form.id }}</code>
        </div>
        
        <div class="endpoint-info">
            <h3>Content-Type</h3>
            <p><code>multipart/form-data</code> or <code>application/x-www-form-urlencoded</code></p>
            
            <h3>Rate Limiting</h3>
            <p>{{ form.rate_limit_per_ip_per_minute or 5 }} requests per minute per IP address</p>
            
            <h3>Required Headers</h3>
            <ul>
                <li><code>Origin</code> - Must match allowed domains for this form</li>
            </ul>
        </div>
    </div>
</div>

<div class="card">
    <h2>Security Requirements</h2>
    <p>This form has the following security measures enabled:</p>
    
    <div class="security-details">
        {% if form.honeypot_enabled %}
        <div class="security-item">
            <h3>üçØ Honeypot Protection</h3>
            <p><strong>Status:</strong> <span class="badge success">Enabled</span></p>
            <p><strong>Field Name:</strong> <code>{{ form.honeypot_field or "_honeypot" }}</code></p>
            <p><strong>Requirement:</strong> Include this hidden field in your form. It must remain empty.</p>
            <pre><code>&lt;input type="hidden" name="{{ form.honeypot_field or "_honeypot" }}" value=""&gt;</code></pre>
        </div>
        {% endif %}
        
        {% if form.hcaptcha_enabled %}
        <div class="security-item">
            <h3>üîí hCaptcha Protection</h3>
            <p><strong>Status:</strong> <span class="badge success">Enabled</span></p>
            <p><strong>Mode:</strong> Always Challenge</p>
            <p><strong>Site Key:</strong> <code>{{ form.hcaptcha_site_key or "Using global configuration" }}</code></p>
            <p><strong>Requirement:</strong> Include hCaptcha token in your form submission.</p>
            <pre><code>&lt;input type="hidden" name="h-captcha-response" value="[token]"&gt;</code></pre>
        </div>
        {% endif %}
        
        <div class="security-item">
            <h3>üõ°Ô∏è Enhanced Security Features</h3>
            <p><strong>CSRF Protection:</strong> <span class="badge success">Enabled</span></p>
            <p><strong>Custom Headers Required:</strong> <code>X-Requested-With</code>, <code>X-Form-Origin</code></p>
            <p><strong>Form Tokens:</strong> Time-limited tokens (15 minutes) required for submission</p>
            <p><strong>Origin Validation:</strong> Both Origin and Referer headers validated</p>
            <p><strong>Requirement:</strong> All submissions must use JavaScript with proper security headers and tokens.</p>
        </div>
        
        {% if not form.honeypot_enabled and not form.hcaptcha_enabled %}
        <div class="security-item">
            <p><strong>Additional security measures:</strong> Consider enabling honeypot protection or hCaptcha for even stronger spam prevention.</p>
        </div>
        {% endif %}
    </div>
</div>

<div class="card">
    <h2>Example Implementation</h2>
    <p>Here's how to implement form submission in different environments:</p>
    
    <div class="code-tabs">
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="showTab(this, 'js-code')">JavaScript</button>
            <button class="tab-btn" onclick="showTab(this, 'react-code')">React</button>
            <button class="tab-btn" onclick="showTab(this, 'curl-code')">cURL</button>
        </div>
        
        <div id="js-code" class="tab-content active">
            <pre><code>// Enhanced form submission with security fields and token
const form = document.querySelector('form');
form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    try {
        // Step 1: Get a form token for CSRF protection
        const tokenResponse = await fetch('{{ request.base_url }}api/v1/form/{{ form.id }}/token', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-Form-Origin': window.location.origin
            }
        });
        
        if (!tokenResponse.ok) {
            throw new Error('Failed to get form token');
        }
        
        const tokenData = await tokenResponse.json();
        
        // Step 2: Prepare form data with security fields
        const formData = new FormData(form);
        
        // Add form token for CSRF protection
        formData.append('form_token', tokenData.token);
        
        {% if form.honeypot_enabled %}
        // Add honeypot field (must be empty)
        formData.append('{{ form.honeypot_field or "_honeypot" }}', '');
        {% endif %}
        
        {% if form.hcaptcha_enabled %}
        // Add hCaptcha token (Always Challenge mode)
        // Note: You'll need to implement hCaptcha widget and get the response token
        const hcaptchaToken = hcaptcha.getResponse(); // Get response from hCaptcha widget
        if (!hcaptchaToken) {
            alert('Please complete the hCaptcha challenge');
            return;
        }
        formData.append('h-captcha-response', hcaptchaToken);
        {% endif %}
        
        // Step 3: Submit form with all security fields
        const response = await fetch('{{ request.base_url }}api/v1/form/{{ form.id }}', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-Form-Origin': window.location.origin
            },
            body: formData
        });
        
        const result = await response.json();
        if (result.status === 'success') {
            console.log('Form submitted successfully:', result.message);
            {% if form.redirect_url %}
            window.location.href = '{{ form.redirect_url }}';
            {% else %}
            alert(result.message);
            form.reset();
            {% endif %}
        } else {
            console.error('Form submission failed:', result.message);
            alert('Error: ' + result.message);
        }
    } catch (error) {
        console.error('Network error:', error);
        alert('Submission failed: ' + error.message);
    }
});</code></pre>
        </div>
        
        <div id="react-code" class="tab-content">
            <pre><code>import { useState } from 'react';

function ContactForm() {
    const [formData, setFormData] = useState({
        name: '',
        email: '',
        message: ''
    });
    const [status, setStatus] = useState(null);
    
    const handleSubmit = async (e) => {
        e.preventDefault();
        setStatus('submitting');
        
        try {
            // Step 1: Get a form token for CSRF protection
            const tokenResponse = await fetch('{{ request.base_url }}api/v1/form/{{ form.id }}/token', {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-Form-Origin': window.location.origin
                }
            });
            
            if (!tokenResponse.ok) {
                throw new Error('Failed to get form token');
            }
            
            const tokenData = await tokenResponse.json();
            
            // Step 2: Prepare form data with security fields
            const form = new FormData();
            for (const key in formData) {
                form.append(key, formData[key]);
            }
            
            // Add form token for CSRF protection
            form.append('form_token', tokenData.token);
            
            {% if form.honeypot_enabled %}
            // Add honeypot field (must be empty)
            form.append('{{ form.honeypot_field or "_honeypot" }}', '');
            {% endif %}
            
            {% if form.recaptcha_enabled %}
            // Add reCAPTCHA token
            const recaptchaToken = await window.grecaptcha.execute('{{ form.recaptcha_site_key }}', {action: 'submit'});
            form.append('g-recaptcha-response', recaptchaToken);
            {% endif %}
            
            // Step 3: Submit form with all security fields
            const response = await fetch('{{ request.base_url }}api/v1/form/{{ form.id }}', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-Form-Origin': window.location.origin
                },
                body: form
            });
            
            const result = await response.json();
            if (result.status === 'success') {
                setStatus('success');
                setFormData({ name: '', email: '', message: '' });
            } else {
                setStatus('error');
                console.error(result.message);
            }
        } catch (error) {
            setStatus('error');
            console.error(error);
        }
    };
    
    return (
        &lt;form onSubmit={handleSubmit}&gt;
            {/* Your form fields here */}
            {% if form.honeypot_enabled %}
            &lt;input type="hidden" name="{{ form.honeypot_field or "_honeypot" }}" value="" /&gt;
            {% endif %}
            &lt;button type="submit" disabled={status === 'submitting'}&gt;
                {status === 'submitting' ? 'Sending...' : 'Send Message'}
            &lt;/button&gt;
        &lt;/form&gt;
    );
}</code></pre>
        </div>
        
        <div id="curl-code" class="tab-content">
            <pre><code># Enhanced cURL example with token-based security

# Step 1: Get a form token
TOKEN=$(curl -s -X GET '{{ request.base_url }}api/v1/form/{{ form.id }}/token' \
  -H 'Origin: https://yourdomain.com' \
  -H 'X-Requested-With: XMLHttpRequest' \
  -H 'X-Form-Origin: https://yourdomain.com' | jq -r '.token')

# Step 2: Submit form with token and security headers
curl -X POST '{{ request.base_url }}api/v1/form/{{ form.id }}' \
  -H 'Origin: https://yourdomain.com' \
  -H 'Referer: https://yourdomain.com/contact' \
  -H 'X-Requested-With: XMLHttpRequest' \
  -H 'X-Form-Origin: https://yourdomain.com' \
  -F "form_token=$TOKEN" \
  -F 'name=John Doe' \
  -F 'email=john@example.com' \
  -F 'message=Hello from the contact form!'{% if form.honeypot_enabled %} \
  -F '{{ form.honeypot_field or "_honeypot" }}='{% endif %}{% if form.recaptcha_enabled %} \
  -F 'g-recaptcha-response=YOUR_RECAPTCHA_TOKEN'{% endif %}</code></pre>
        </div>
    </div>
</div>

<div class="grid-row">
    <div class="grid-col">
        <div class="card">
            <h2>Response Format</h2>
            
            <h3>Success Response</h3>
            <pre><code>{
    "status": "success",
    "message": "{{ form.success_message or 'Form submitted successfully' }}",
    "redirect": {{ '"' + form.redirect_url + '"' if form.redirect_url else 'null' }}
}</code></pre>
            
            <h3>Error Response</h3>
            <pre><code>{
    "status": "error",
    "message": "Error description"
}</code></pre>
            
            <h3>HTTP Status Codes</h3>
            <ul>
                <li><code>200</code> - Form submitted successfully</li>
                <li><code>400</code> - Invalid request or validation failed</li>
                <li><code>403</code> - Origin not allowed or security check failed</li>
                <li><code>404</code> - Form not found</li>
                <li><code>429</code> - Rate limit exceeded</li>
                <li><code>500</code> - Internal server error</li>
            </ul>
        </div>
    </div>
    
    <div class="grid-col">
        <div class="card">
            <h2>Form Details</h2>
            
            <div class="details-table">
                <div class="details-row">
                    <div class="details-label">ID</div>
                    <div class="details-value">{{ form.id }}</div>
                </div>
                
                <div class="details-row">
                    <div class="details-label">Name</div>
                    <div class="details-value">{{ form.name }}</div>
                </div>
                
                <div class="details-row">
                    <div class="details-label">Recipients</div>
                    <div class="details-value">
                        {% if form.to_emails %}
                            {% for email in form.to_emails.split(',') %}
                                <div>{{ email.strip() }}</div>
                            {% endfor %}
                        {% else %}
                            -
                        {% endif %}
                    </div>
                </div>
                
                <div class="details-row">
                    <div class="details-label">Allowed Domains</div>
                    <div class="details-value">
                        {% if form.domains %}
                            {% for domain in form.domains %}
                                <span class="domain-badge">{{ domain.domain }}</span>
                            {% endfor %}
                        {% else %}
                            <span class="domain-badge">*</span> (All domains)
                        {% endif %}
                    </div>
                </div>
                
                <div class="details-row">
                    <div class="details-label">Honeypot Protection</div>
                    <div class="details-value">
                        {% if form.honeypot_enabled %}
                            <span class="badge success">Enabled</span>
                            <div><small>Field: <code>{{ form.honeypot_field or "_honeypot" }}</code></small></div>
                        {% else %}
                            <span class="badge danger">Disabled</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="details-row">
                    <div class="details-label">hCaptcha Protection</div>
                    <div class="details-value">
                        {% if form.hcaptcha_enabled %}
                            <span class="badge success">Enabled (Always Challenge)</span>
                        {% else %}
                            <span class="badge danger">Disabled</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="details-row">
                    <div class="details-label">Created</div>
                    <div class="details-value">
                        {% if form.created_at %}
                            {{ form.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                        {% else %}
                            -
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}